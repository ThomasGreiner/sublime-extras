#!/bin/bash

user_dir="/home/${USER}/.config/sublime-text-3/Packages/User"

usage() {
cat << EOF
Usage: $0 <command>

COMMANDS:
  create    Create files for Sublime Text 3
  deploy    Create and copy files to user configuration directory
  monitor   Monitor file changes and auto-deploy to user configuration directory
EOF
}

build_color_scheme() {
  echo "Updating ${user_dir}/todo.tmTheme"
  ./yaml2plist.js theme.yaml > todo.tmTheme
  xsltproc -o todo.tmTheme theme.xsl todo.tmTheme
}

build_syntax() {
  echo "Updating ${user_dir}/todo.tmLanguage"
  ./yaml2plist.js language.yaml > todo.tmLanguage
}

case "$1" in
  "create")
    build_color_scheme
    build_syntax
    ;;
  "deploy")
    build_color_scheme
    build_syntax
    mv todo.tmTheme "${user_dir}/todo.tmTheme"
    mv todo.tmLanguage "${user_dir}/todo.tmLanguage"
    ;;
  "monitor")
    echo "Monitoring file changesâ€¦"
    while true; do
      event=$(inotifywait -qe close_write .)
      file=${event#./ * }
      case "$file" in
        "todo.tmLanguage")
          build_syntax
          ;;
        "todo.tmTheme")
          build_color_scheme
          ;;
      esac
    done
    ;;
  *)
    usage
esac
